<%- include('../partials/header', { title: '文件管理', user: user }) %>

<div class="card">
  <div style="margin-bottom: 20px">
    <a href="/admin/dashboard" class="btn btn-secondary">← 返回后台首页</a>
  </div>

  <h1>文件管理</h1>
  <p style="color: #666; margin-bottom: 20px">管理所有用户上传的文件</p>

  <% if (files.length === 0) { %>
  <div class="empty-state">
    <p style="font-size: 18px">暂无文件</p>
  </div>
  <% } else { %>
  <table>
    <thead>
      <tr>
        <th>文件名</th>
        <th>上传者</th>
        <th>大小</th>
        <th>类型</th>
        <th>状态</th>
        <th>上传时间</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody>
      <% files.forEach(file => { %>
      <tr>
        <td><%= file.originalName %></td>
        <td><%= file.uploaderName %></td>
        <td><%= (file.size / 1024).toFixed(2) %> KB</td>
        <td><%= file.mimetype %></td>
        <td>
          <% if (file.isPublic) { %>
          <span style="color: green">公开</span>
          <% } else { %>
          <span style="color: gray">私有</span>
          <% } %>
        </td>
        <td><%= new Date(file.uploadedAt).toLocaleString('zh-CN') %></td>
        <td>
          <a
            href="/files/view/<%= file.id %>"
            class="btn btn-primary"
            style="margin-right: 5px"
            >查看</a
          >
          <button class="btn btn-danger" onclick="deleteFile('<%= file.id %>')">
            删除
          </button>
        </td>
      </tr>
      <% }); %>
    </tbody>
  </table>
  <% } %>
</div>

<script>
  async function deleteFile(fileId) {
    if (!confirm("确定要删除这个文件吗？此操作不可恢复！")) {
      return;
    }

    try {
      const response = await fetch("/admin/files/" + fileId, {
        method: "DELETE",
      });

      const result = await response.json();

      if (result.success) {
        alert("删除成功！");
        location.reload();
      } else {
        alert("删除失败: " + result.message);
      }
    } catch (error) {
      alert("删除失败，请稍后重试");
    }
  }
</script>

<%- include('../partials/footer') %>
