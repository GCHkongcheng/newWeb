<%- include('../partials/header', { title: '文件管理', user: user }) %>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <!-- Back Button -->
  <div class="mb-6">
    <a
      href="/admin/dashboard"
      class="inline-flex items-center space-x-2 text-primary hover:text-secondary transition-colors"
    >
      <i class="bi bi-arrow-left"></i>
      <span>返回后台首页</span>
    </a>
  </div>

  <!-- Header -->
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900 flex items-center mb-2">
      <i class="bi bi-file-earmark-text mr-3 text-primary"></i>
      文件管理
    </h1>
    <p class="text-gray-600">管理所有用户上传的文件</p>
  </div>

  <% if (files.length === 0) { %>
  <!-- Empty State -->
  <div class="bg-white rounded-xl shadow-md p-12 text-center">
    <i class="bi bi-inbox text-6xl text-gray-300 mb-4"></i>
    <p class="text-xl text-gray-600">暂无文件</p>
  </div>
  <% } else { %>
  <!-- Desktop Table View -->
  <div class="hidden lg:block bg-white rounded-xl shadow-md overflow-hidden">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th
            class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
          >
            文件名
          </th>
          <th
            class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
          >
            上传者
          </th>
          <th
            class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
          >
            大小
          </th>
          <th
            class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
          >
            类型
          </th>
          <th
            class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
          >
            状态
          </th>
          <th
            class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
          >
            上传时间
          </th>
          <th
            class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
          >
            操作
          </th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        <% files.forEach(file => { %>
        <tr class="hover:bg-gray-50 transition-colors">
          <td class="px-6 py-4">
            <div class="flex items-center">
              <i class="bi bi-file-earmark-text text-2xl text-primary mr-3"></i>
              <span class="text-sm font-medium text-gray-900"
                ><%= file.originalName %></span
              >
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
            <i class="bi bi-person-circle mr-1"></i><%= file.uploaderName %>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
            <%= (file.size / 1024).toFixed(2) %> KB
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
            <span class="px-2 py-1 bg-gray-100 rounded text-xs"
              ><%= file.mimetype %></span
            >
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <% if (file.isPublic) { %>
            <span
              class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800"
            >
              <i class="bi bi-globe mr-1"></i> 公开
            </span>
            <% } else { %>
            <span
              class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800"
            >
              <i class="bi bi-lock mr-1"></i> 私有
            </span>
            <% } %>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
            <%= new Date(file.uploadedAt).toLocaleString('zh-CN') %>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-3">
            <a
              href="/files/view/<%= file.id %>"
              class="text-primary hover:text-secondary transition-colors"
            >
              <i class="bi bi-eye"></i>
            </a>
            <button
              onclick="deleteFile('<%= file.id %>')"
              class="text-red-600 hover:text-red-800 transition-colors"
            >
              <i class="bi bi-trash"></i>
            </button>
          </td>
        </tr>
        <% }); %>
      </tbody>
    </table>
  </div>

  <!-- Mobile Card View -->
  <div class="lg:hidden space-y-4">
    <% files.forEach(file => { %>
    <div
      class="bg-white rounded-xl shadow-md p-4 hover:shadow-lg transition-shadow"
    >
      <div class="flex items-start justify-between mb-3">
        <div class="flex items-center flex-1 min-w-0">
          <i
            class="bi bi-file-earmark-text text-3xl text-primary mr-3 flex-shrink-0"
          ></i>
          <div class="min-w-0 flex-1">
            <h3 class="text-sm font-medium text-gray-900 truncate">
              <%= file.originalName %>
            </h3>
            <p class="text-xs text-gray-500">
              <i class="bi bi-person-circle mr-1"></i><%= file.uploaderName %> ·
              <%= (file.size / 1024).toFixed(2) %> KB
            </p>
          </div>
        </div>
        <% if (file.isPublic) { %>
        <span
          class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800 flex-shrink-0 ml-2"
        >
          <i class="bi bi-globe"></i>
        </span>
        <% } else { %>
        <span
          class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-800 flex-shrink-0 ml-2"
        >
          <i class="bi bi-lock"></i>
        </span>
        <% } %>
      </div>
      <div class="text-xs text-gray-500 mb-3">
        <%= new Date(file.uploadedAt).toLocaleString('zh-CN') %>
      </div>
      <div class="flex space-x-2">
        <a
          href="/files/view/<%= file.id %>"
          class="flex-1 text-center px-3 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-colors text-sm"
        >
          <i class="bi bi-eye mr-1"></i>查看
        </a>
        <button
          onclick="deleteFile('<%= file.id %>')"
          class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors text-sm"
        >
          <i class="bi bi-trash"></i>
        </button>
      </div>
    </div>
    <% }); %>
  </div>
  <% } %>
</div>

<script>
  async function deleteFile(fileId) {
    if (!confirm("确定要删除这个文件吗？此操作不可恢复！")) {
      return;
    }

    try {
      const response = await fetch("/admin/files/" + fileId, {
        method: "DELETE",
      });

      const result = await response.json();

      if (result.success) {
        alert("删除成功！");
        location.reload();
      } else {
        alert("删除失败: " + result.message);
      }
    } catch (error) {
      alert("删除失败，请稍后重试");
    }
  }
</script>

<%- include('../partials/footer') %>
