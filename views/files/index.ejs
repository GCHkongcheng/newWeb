<%- include('../partials/header', { title: '我的文件', user: user }) %>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <!-- Header -->
  <div
    class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8"
  >
    <h1 class="text-3xl font-bold text-gray-900 flex items-center">
      <i class="bi bi-folder2-open mr-3 text-primary"></i>
      我的文件
    </h1>
    <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
      <div class="relative">
        <input
          type="text"
          id="searchInput"
          placeholder="搜索文件名..."
          class="w-full sm:w-64 pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
          onkeyup="searchFiles()"
        />
        <i class="bi bi-search absolute left-3 top-3 text-gray-400"></i>
      </div>
      <button
        onclick="document.getElementById('uploadModal').classList.remove('hidden')"
        class="bg-primary hover:bg-secondary text-white px-6 py-2 rounded-lg transition-all duration-200 flex items-center justify-center space-x-2 shadow-lg hover:shadow-xl"
      >
        <i class="bi bi-cloud-upload"></i>
        <span>上传文件</span>
      </button>
    </div>
  </div>

  <!-- Files List -->
  <% if (files.length === 0) { %>
  <div class="bg-white rounded-xl shadow-md p-12 text-center">
    <i class="bi bi-inbox text-6xl text-gray-300 mb-4"></i>
    <p class="text-xl text-gray-600 mb-2">还没有上传任何文件</p>
    <p class="text-gray-400">点击上传按钮开始使用</p>
  </div>
  <% } else { %>
  <!-- Desktop Table View -->
  <div class="hidden lg:block bg-white rounded-xl shadow-md overflow-hidden">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th
            class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
          >
            文件名
          </th>
          <th
            class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
          >
            大小
          </th>
          <th
            class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
          >
            类型
          </th>
          <th
            class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
          >
            上传时间
          </th>
          <th
            class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
          >
            状态
          </th>
          <th
            class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
          >
            操作
          </th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200" id="filesTable">
        <% files.forEach(file => { %>
        <tr class="hover:bg-gray-50 transition-colors">
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="flex items-center">
              <i class="bi bi-file-earmark-text text-2xl text-primary mr-3"></i>
              <span class="text-sm font-medium text-gray-900"
                ><%= file.originalName %></span
              >
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
            <%= (file.size / 1024).toFixed(2) %> KB
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
            <span class="px-2 py-1 bg-gray-100 rounded text-xs"
              ><%= file.mimetype %></span
            >
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
            <%= new Date(file.uploadedAt).toLocaleString('zh-CN') %>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <% if (file.isPublic) { %>
            <span
              class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800"
            >
              <i class="bi bi-globe mr-1"></i> 公开
            </span>
            <% } else { %>
            <span
              class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800"
            >
              <i class="bi bi-lock mr-1"></i> 私有
            </span>
            <% } %>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
            <a
              href="/files/view/<%= file.id %>"
              class="text-primary hover:text-secondary transition-colors"
            >
              <i class="bi bi-eye"></i>
            </a>
            <a
              href="/files/download/<%= file.id %>"
              class="text-blue-600 hover:text-blue-800 transition-colors"
            >
              <i class="bi bi-download"></i>
            </a>
            <button
              onclick="deleteFile('<%= file.id %>')"
              class="text-red-600 hover:text-red-800 transition-colors"
            >
              <i class="bi bi-trash"></i>
            </button>
          </td>
        </tr>
        <% }); %>
      </tbody>
    </table>
  </div>

  <!-- Mobile Card View -->
  <div class="lg:hidden space-y-4" id="filesMobile">
    <% files.forEach(file => { %>
    <div
      class="bg-white rounded-xl shadow-md p-4 hover:shadow-lg transition-shadow"
    >
      <div class="flex items-start justify-between mb-3">
        <div class="flex items-center flex-1 min-w-0">
          <i
            class="bi bi-file-earmark-text text-3xl text-primary mr-3 flex-shrink-0"
          ></i>
          <div class="min-w-0 flex-1">
            <h3 class="text-sm font-medium text-gray-900 truncate">
              <%= file.originalName %>
            </h3>
            <p class="text-xs text-gray-500">
              <%= (file.size / 1024).toFixed(2) %> KB
            </p>
          </div>
        </div>
        <% if (file.isPublic) { %>
        <span
          class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800 flex-shrink-0"
        >
          <i class="bi bi-globe"></i>
        </span>
        <% } else { %>
        <span
          class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-800 flex-shrink-0"
        >
          <i class="bi bi-lock"></i>
        </span>
        <% } %>
      </div>
      <div class="text-xs text-gray-500 mb-3">
        <%= new Date(file.uploadedAt).toLocaleString('zh-CN') %>
      </div>
      <div class="flex space-x-2">
        <a
          href="/files/view/<%= file.id %>"
          class="flex-1 text-center px-3 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-colors text-sm"
        >
          <i class="bi bi-eye mr-1"></i>查看
        </a>
        <a
          href="/files/download/<%= file.id %>"
          class="flex-1 text-center px-3 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors text-sm"
        >
          <i class="bi bi-download mr-1"></i>下载
        </a>
        <button
          onclick="deleteFile('<%= file.id %>')"
          class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors text-sm"
        >
          <i class="bi bi-trash"></i>
        </button>
      </div>
    </div>
    <% }); %>
  </div>
  <% } %>
</div>

<!-- Upload Modal -->
<div
  id="uploadModal"
  class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"
>
  <div
    class="bg-white rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto"
  >
    <div class="p-6">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-900 flex items-center">
          <i class="bi bi-cloud-upload mr-2 text-primary"></i>
          上传文件
        </h2>
        <button
          onclick="document.getElementById('uploadModal').classList.add('hidden')"
          class="text-gray-400 hover:text-gray-600 transition-colors"
        >
          <i class="bi bi-x-lg text-2xl"></i>
        </button>
      </div>

      <form id="uploadForm" enctype="multipart/form-data" class="space-y-5">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2"
            >选择文件</label
          >
          <div class="relative">
            <input
              type="file"
              name="file"
              id="fileInput"
              accept=".txt,.md,.cpp,.py,.js,.html,.css,.json,.xml,.java,.c,.h,.cs"
              required
              class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-primary file:text-white hover:file:bg-secondary file:cursor-pointer cursor-pointer"
            />
          </div>
          <p class="mt-2 text-xs text-gray-500">
            支持: txt, md, cpp, py, js, html, css, json, xml, java, c, h, cs
          </p>
        </div>

        <div class="flex items-center">
          <input
            type="checkbox"
            name="isPublic"
            id="isPublic"
            class="w-4 h-4 text-primary focus:ring-primary border-gray-300 rounded"
          />
          <label for="isPublic" class="ml-2 text-sm text-gray-700"
            >公开此文件</label
          >
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2"
            >描述（可选）</label
          >
          <textarea
            name="description"
            id="description"
            rows="3"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-all resize-none"
            placeholder="添加文件描述..."
          ></textarea>
        </div>

        <div class="flex space-x-3 pt-4">
          <button
            type="submit"
            class="flex-1 bg-primary hover:bg-secondary text-white py-3 rounded-lg font-medium transition-all duration-200 flex items-center justify-center space-x-2"
          >
            <i class="bi bi-upload"></i>
            <span>开始上传</span>
          </button>
          <button
            type="button"
            onclick="document.getElementById('uploadModal').classList.add('hidden')"
            class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-3 rounded-lg font-medium transition-all duration-200"
          >
            取消
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  document
    .getElementById("uploadForm")
    .addEventListener("submit", async (e) => {
      e.preventDefault();

      const formData = new FormData();
      const fileInput = document.getElementById("fileInput");
      const isPublic = document.getElementById("isPublic").checked;
      const description = document.getElementById("description").value;

      if (!fileInput.files[0]) {
        alert("请选择文件");
        return;
      }

      formData.append("file", fileInput.files[0]);
      formData.append("isPublic", isPublic);
      formData.append("description", description);

      try {
        const response = await fetch("/files/upload", {
          method: "POST",
          body: formData,
        });

        const result = await response.json();

        if (result.success) {
          alert("上传成功！");
          location.reload();
        } else {
          alert("上传失败: " + result.message);
        }
      } catch (error) {
        alert("上传失败，请稍后重试");
      }
    });

  async function deleteFile(fileId) {
    if (!confirm("确定要删除这个文件吗？文件将移至回收站。")) {
      return;
    }

    try {
      const response = await fetch("/files/" + fileId, {
        method: "DELETE",
      });

      const result = await response.json();

      if (result.success) {
        alert(result.message);
        location.reload();
      } else {
        alert("删除失败: " + result.message);
      }
    } catch (error) {
      alert("删除失败，请稍后重试");
    }
  }

  function searchFiles() {
    const input = document.getElementById("searchInput");
    const filter = input.value.toLowerCase();

    // Desktop table search
    const tableBody = document.getElementById("filesTable");
    if (tableBody) {
      const rows = tableBody.getElementsByTagName("tr");
      for (let i = 0; i < rows.length; i++) {
        const nameCell = rows[i].getElementsByTagName("td")[0];
        if (nameCell) {
          const textValue = nameCell.textContent || nameCell.innerText;
          if (textValue.toLowerCase().indexOf(filter) > -1) {
            rows[i].style.display = "";
          } else {
            rows[i].style.display = "none";
          }
        }
      }
    }

    // Mobile cards search
    const mobileContainer = document.getElementById("filesMobile");
    if (mobileContainer) {
      const cards = mobileContainer.children;
      for (let i = 0; i < cards.length; i++) {
        const h3 = cards[i].getElementsByTagName("h3")[0];
        if (h3) {
          const textValue = h3.textContent || h3.innerText;
          if (textValue.toLowerCase().indexOf(filter) > -1) {
            cards[i].style.display = "";
          } else {
            cards[i].style.display = "none";
          }
        }
      }
    }
  }
</script>

<%- include('../partials/footer') %>
